#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2024/9/14 17:31
# @Author  : shenglin.li
# @File    : ops_test.py
# @Software: PyCharm
from collections import deque

import numpy as np

from leek.common import G
from leek.f.ops import Processor
from leek.t import MA

rows = [
    {'timestamp': '1609430400000', 'open': '0.2148', 'high': '0.2151', 'low': '0.2143', 'close': '0.2147', 'volume': '3535', 'amount': '75905.28', 'interval': '1m'}, {'timestamp': '1609430460000', 'open': '0.2147', 'high': '0.2149', 'low': '0.2136', 'close': '0.2146', 'volume': '4951', 'amount': '106174.19', 'interval': '1m'}, {'timestamp': '1609430520000', 'open': '0.2146', 'high': '0.216', 'low': '0.2145', 'close': '0.2148', 'volume': '4012', 'amount': '86247.97', 'interval': '1m'}, {'timestamp': '1609430580000', 'open': '0.2147', 'high': '0.2155', 'low': '0.2146', 'close': '0.215', 'volume': '3185', 'amount': '68461.57', 'interval': '1m'}, {'timestamp': '1609430640000', 'open': '0.215', 'high': '0.2169', 'low': '0.215', 'close': '0.2169', 'volume': '5207', 'amount': '112445.16', 'interval': '1m'}, {'timestamp': '1609430700000', 'open': '0.2169', 'high': '0.2186', 'low': '0.2169', 'close': '0.2177', 'volume': '3964', 'amount': '86226.91', 'interval': '1m'}, {'timestamp': '1609430760000', 'open': '0.2178', 'high': '0.2196', 'low': '0.2175', 'close': '0.2178', 'volume': '14552', 'amount': '317488.26', 'interval': '1m'}, {'timestamp': '1609430820000', 'open': '0.2177', 'high': '0.218', 'low': '0.2173', 'close': '0.2173', 'volume': '2863', 'amount': '62291.72', 'interval': '1m'}, {'timestamp': '1609430880000', 'open': '0.2173', 'high': '0.2173', 'low': '0.2163', 'close': '0.2169', 'volume': '7004', 'amount': '151951.78', 'interval': '1m'}, {'timestamp': '1609430940000', 'open': '0.2169', 'high': '0.2171', 'low': '0.2157', 'close': '0.2157', 'volume': '2196', 'amount': '47510.46', 'interval': '1m'}, {'timestamp': '1609431000000', 'open': '0.2158', 'high': '0.2164', 'low': '0.2158', 'close': '0.2162', 'volume': '2131', 'amount': '46040.25', 'interval': '1m'}, {'timestamp': '1609431060000', 'open': '0.216', 'high': '0.217', 'low': '0.2159', 'close': '0.2162', 'volume': '2244', 'amount': '48532.11', 'interval': '1m'}, {'timestamp': '1609431120000', 'open': '0.2164', 'high': '0.2166', 'low': '0.2157', 'close': '0.2157', 'volume': '1350', 'amount': '29173.5', 'interval': '1m'}, {'timestamp': '1609431180000', 'open': '0.2157', 'high': '0.2161', 'low': '0.2154', 'close': '0.2161', 'volume': '492', 'amount': '10618.59', 'interval': '1m'}, {'timestamp': '1609431240000', 'open': '0.2163', 'high': '0.2169', 'low': '0.2161', 'close': '0.2161', 'volume': '922', 'amount': '19947.47', 'interval': '1m'}, {'timestamp': '1609431300000', 'open': '0.2161', 'high': '0.2168', 'low': '0.2161', 'close': '0.2165', 'volume': '443', 'amount': '9585.41', 'interval': '1m'}, {'timestamp': '1609431360000', 'open': '0.2164', 'high': '0.2164', 'low': '0.2158', 'close': '0.2162', 'volume': '2738', 'amount': '59195.56', 'interval': '1m'}, {'timestamp': '1609431420000', 'open': '0.2162', 'high': '0.2169', 'low': '0.2161', 'close': '0.2168', 'volume': '1598', 'amount': '34596.7', 'interval': '1m'}, {'timestamp': '1609431480000', 'open': '0.2168', 'high': '0.2185', 'low': '0.2168', 'close': '0.2185', 'volume': '5847', 'amount': '127259.95', 'interval': '1m'}, {'timestamp': '1609431540000', 'open': '0.2183', 'high': '0.2205', 'low': '0.2182', 'close': '0.2204', 'volume': '11191', 'amount': '245474.58', 'interval': '1m'}, {'timestamp': '1609431600000', 'open': '0.2205', 'high': '0.2223', 'low': '0.2192', 'close': '0.2194', 'volume': '9486', 'amount': '209024.01', 'interval': '1m'}, {'timestamp': '1609431660000', 'open': '0.2195', 'high': '0.2203', 'low': '0.219', 'close': '0.2196', 'volume': '6337', 'amount': '139160.52', 'interval': '1m'}, {'timestamp': '1609431720000', 'open': '0.2196', 'high': '0.2199', 'low': '0.2185', 'close': '0.2189', 'volume': '4828', 'amount': '105841.83', 'interval': '1m'}, {'timestamp': '1609431780000', 'open': '0.2187', 'high': '0.2195', 'low': '0.2181', 'close': '0.2188', 'volume': '5879', 'amount': '128617.82', 'interval': '1m'}, {'timestamp': '1609431840000', 'open': '0.2191', 'high': '0.2195', 'low': '0.2188', 'close': '0.2188', 'volume': '1541', 'amount': '33755.6', 'interval': '1m'}, {'timestamp': '1609431900000', 'open': '0.2189', 'high': '0.2195', 'low': '0.2185', 'close': '0.2193', 'volume': '3074', 'amount': '67335.97', 'interval': '1m'}, {'timestamp': '1609431960000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2187', 'close': '0.2187', 'volume': '888', 'amount': '19438.32', 'interval': '1m'}, {'timestamp': '1609432020000', 'open': '0.2188', 'high': '0.2192', 'low': '0.2188', 'close': '0.2191', 'volume': '3093', 'amount': '67728.96', 'interval': '1m'}, {'timestamp': '1609432080000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2173', 'close': '0.2174', 'volume': '860', 'amount': '18767.35', 'interval': '1m'}, {'timestamp': '1609432140000', 'open': '0.2176', 'high': '0.218', 'low': '0.2176', 'close': '0.218', 'volume': '819', 'amount': '17837.82', 'interval': '1m'}, {'timestamp': '1609432200000', 'open': '0.2179', 'high': '0.2184', 'low': '0.2179', 'close': '0.2184', 'volume': '530', 'amount': '11561.95', 'interval': '1m'}, {'timestamp': '1609432260000', 'open': '0.2184', 'high': '0.2186', 'low': '0.2179', 'close': '0.2184', 'volume': '4051', 'amount': '88443.45', 'interval': '1m'}, {'timestamp': '1609432320000', 'open': '0.2182', 'high': '0.2182', 'low': '0.2173', 'close': '0.2178', 'volume': '5775', 'amount': '125822.81', 'interval': '1m'}, {'timestamp': '1609432380000', 'open': '0.2178', 'high': '0.2181', 'low': '0.2176', 'close': '0.2179', 'volume': '1324', 'amount': '28843.34', 'interval': '1m'}, {'timestamp': '1609432440000', 'open': '0.2177', 'high': '0.218', 'low': '0.2177', 'close': '0.2177', 'volume': '697', 'amount': '15178.91', 'interval': '1m'}, {'timestamp': '1609432500000', 'open': '0.2176', 'high': '0.2178', 'low': '0.2175', 'close': '0.2175', 'volume': '342', 'amount': '7441.92', 'interval': '1m'}, {'timestamp': '1609432560000', 'open': '0.2177', 'high': '0.218', 'low': '0.2175', 'close': '0.2177', 'volume': '432', 'amount': '9405.72', 'interval': '1m'}, {'timestamp': '1609432620000', 'open': '0.2177', 'high': '0.2177', 'low': '0.2167', 'close': '0.2168', 'volume': '3235', 'amount': '70272.28', 'interval': '1m'}, {'timestamp': '1609432680000', 'open': '0.2169', 'high': '0.2181', 'low': '0.2169', 'close': '0.2179', 'volume': '4791', 'amount': '104180.29', 'interval': '1m'}, {'timestamp': '1609432740000', 'open': '0.2177', 'high': '0.2177', 'low': '0.2171', 'close': '0.2174', 'volume': '1083', 'amount': '23552.54', 'interval': '1m'}, {'timestamp': '1609432800000', 'open': '0.2175', 'high': '0.2175', 'low': '0.217', 'close': '0.2172', 'volume': '1192', 'amount': '25902.16', 'interval': '1m'}, {'timestamp': '1609432860000', 'open': '0.2171', 'high': '0.2175', 'low': '0.2171', 'close': '0.2175', 'volume': '589', 'amount': '12798.97', 'interval': '1m'}, {'timestamp': '1609432920000', 'open': '0.2173', 'high': '0.2174', 'low': '0.2167', 'close': '0.2172', 'volume': '622', 'amount': '13506.73', 'interval': '1m'}, {'timestamp': '1609432980000', 'open': '0.2171', 'high': '0.2174', 'low': '0.2171', 'close': '0.2173', 'volume': '251', 'amount': '5452.34', 'interval': '1m'}, {'timestamp': '1609433040000', 'open': '0.217', 'high': '0.2171', 'low': '0.2164', 'close': '0.2164', 'volume': '1247', 'amount': '27025.6', 'interval': '1m'}, {'timestamp': '1609433100000', 'open': '0.2166', 'high': '0.2171', 'low': '0.2166', 'close': '0.2171', 'volume': '722', 'amount': '15656.57', 'interval': '1m'}, {'timestamp': '1609433160000', 'open': '0.2166', 'high': '0.2172', 'low': '0.2164', 'close': '0.2172', 'volume': '220', 'amount': '4770.7', 'interval': '1m'}, {'timestamp': '1609433220000', 'open': '0.217', 'high': '0.2171', 'low': '0.2168', 'close': '0.2168', 'volume': '397', 'amount': '8611.92', 'interval': '1m'}, {'timestamp': '1609433280000', 'open': '0.2169', 'high': '0.2169', 'low': '0.2168', 'close': '0.2168', 'volume': '257', 'amount': '5573.04', 'interval': '1m'}, {'timestamp': '1609433340000', 'open': '0.2168', 'high': '0.2173', 'low': '0.2167', 'close': '0.2171', 'volume': '368', 'amount': '7984.68', 'interval': '1m'}, {'timestamp': '1609433400000', 'open': '0.2171', 'high': '0.2172', 'low': '0.2156', 'close': '0.2163', 'volume': '4607', 'amount': '99764.58', 'interval': '1m'}, {'timestamp': '1609433460000', 'open': '0.216', 'high': '0.2164', 'low': '0.2151', 'close': '0.2163', 'volume': '3472', 'amount': '74977.84', 'interval': '1m'}, {'timestamp': '1609433520000', 'open': '0.2162', 'high': '0.2164', 'low': '0.2159', 'close': '0.2159', 'volume': '3290', 'amount': '71096.9', 'interval': '1m'}, {'timestamp': '1609433580000', 'open': '0.2159', 'high': '0.2164', 'low': '0.2159', 'close': '0.2163', 'volume': '2267', 'amount': '48995.53', 'interval': '1m'}, {'timestamp': '1609433640000', 'open': '0.2162', 'high': '0.2163', 'low': '0.2159', 'close': '0.2161', 'volume': '1655', 'amount': '35768.68', 'interval': '1m'}, {'timestamp': '1609433700000', 'open': '0.2161', 'high': '0.2161', 'low': '0.2152', 'close': '0.2158', 'volume': '673', 'amount': '14523.34', 'interval': '1m'}, {'timestamp': '1609433760000', 'open': '0.2157', 'high': '0.2159', 'low': '0.2157', 'close': '0.2159', 'volume': '234', 'amount': '5049.72', 'interval': '1m'}, {'timestamp': '1609433820000', 'open': '0.2159', 'high': '0.216', 'low': '0.2158', 'close': '0.216', 'volume': '344', 'amount': '7427.82', 'interval': '1m'}, {'timestamp': '1609433880000', 'open': '0.2161', 'high': '0.2161', 'low': '0.2159', 'close': '0.2161', 'volume': '282', 'amount': '6092.61', 'interval': '1m'}, {'timestamp': '1609433940000', 'open': '0.2161', 'high': '0.2168', 'low': '0.2161', 'close': '0.2164', 'volume': '576', 'amount': '12461.76', 'interval': '1m'}, {'timestamp': '1609434000000', 'open': '0.2164', 'high': '0.2164', 'low': '0.2161', 'close': '0.2162', 'volume': '587', 'amount': '12695.34', 'interval': '1m'}, {'timestamp': '1609434060000', 'open': '0.2161', 'high': '0.2163', 'low': '0.2159', 'close': '0.2161', 'volume': '343', 'amount': '7412.23', 'interval': '1m'}, {'timestamp': '1609434120000', 'open': '0.2161', 'high': '0.2166', 'low': '0.2159', 'close': '0.2163', 'volume': '1896', 'amount': '40996.26', 'interval': '1m'}, {'timestamp': '1609434180000', 'open': '0.2164', 'high': '0.2165', 'low': '0.2163', 'close': '0.2165', 'volume': '433', 'amount': '9371.2', 'interval': '1m'}, {'timestamp': '1609434240000', 'open': '0.2164', 'high': '0.2164', 'low': '0.216', 'close': '0.2162', 'volume': '210', 'amount': '4541.25', 'interval': '1m'}, {'timestamp': '1609434300000', 'open': '0.2162', 'high': '0.2164', 'low': '0.2159', 'close': '0.216', 'volume': '1409', 'amount': '30452.01', 'interval': '1m'}, {'timestamp': '1609434360000', 'open': '0.216', 'high': '0.216', 'low': '0.2148', 'close': '0.2156', 'volume': '3837', 'amount': '82725.72', 'interval': '1m'}, {'timestamp': '1609434420000', 'open': '0.2155', 'high': '0.2158', 'low': '0.2153', 'close': '0.2157', 'volume': '2809', 'amount': '60555.01', 'interval': '1m'}, {'timestamp': '1609434480000', 'open': '0.2156', 'high': '0.2159', 'low': '0.2156', 'close': '0.2157', 'volume': '176', 'amount': '3796.32', 'interval': '1m'}, {'timestamp': '1609434540000', 'open': '0.2158', 'high': '0.2158', 'low': '0.2154', 'close': '0.2155', 'volume': '213', 'amount': '4592.81', 'interval': '1m'}, {'timestamp': '1609434600000', 'open': '0.2156', 'high': '0.2165', 'low': '0.2154', 'close': '0.2165', 'volume': '430', 'amount': '9288', 'interval': '1m'}, {'timestamp': '1609434660000', 'open': '0.2164', 'high': '0.2166', 'low': '0.216', 'close': '0.2162', 'volume': '2747', 'amount': '59417.61', 'interval': '1m'}, {'timestamp': '1609434720000', 'open': '0.2165', 'high': '0.218', 'low': '0.2163', 'close': '0.2178', 'volume': '5642', 'amount': '122516.03', 'interval': '1m'}, {'timestamp': '1609434780000', 'open': '0.2178', 'high': '0.2178', 'low': '0.2169', 'close': '0.2176', 'volume': '2374', 'amount': '51640.43', 'interval': '1m'}, {'timestamp': '1609434840000', 'open': '0.2174', 'high': '0.2176', 'low': '0.217', 'close': '0.2175', 'volume': '566', 'amount': '12303.42', 'interval': '1m'}, {'timestamp': '1609434900000', 'open': '0.2175', 'high': '0.2177', 'low': '0.217', 'close': '0.2177', 'volume': '871', 'amount': '18942.07', 'interval': '1m'}, {'timestamp': '1609434960000', 'open': '0.218', 'high': '0.2201', 'low': '0.218', 'close': '0.2197', 'volume': '20372', 'amount': '446044.94', 'interval': '1m'}, {'timestamp': '1609435020000', 'open': '0.2199', 'high': '0.2214', 'low': '0.2199', 'close': '0.2203', 'volume': '6281', 'amount': '138417.53', 'interval': '1m'}, {'timestamp': '1609435080000', 'open': '0.2201', 'high': '0.2209', 'low': '0.2197', 'close': '0.2199', 'volume': '13709', 'amount': '301803.63', 'interval': '1m'}, {'timestamp': '1609435140000', 'open': '0.2199', 'high': '0.2201', 'low': '0.2187', 'close': '0.219', 'volume': '4131', 'amount': '90644.46', 'interval': '1m'}, {'timestamp': '1609435200000', 'open': '0.2186', 'high': '0.2193', 'low': '0.2184', 'close': '0.2188', 'volume': '2522', 'amount': '55175.05', 'interval': '1m'}, {'timestamp': '1609435260000', 'open': '0.2188', 'high': '0.2191', 'low': '0.2177', 'close': '0.2191', 'volume': '7121', 'amount': '155718.46', 'interval': '1m'}, {'timestamp': '1609435320000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2178', 'close': '0.2178', 'volume': '2531', 'amount': '55289.69', 'interval': '1m'}, {'timestamp': '1609435380000', 'open': '0.2181', 'high': '0.2194', 'low': '0.2181', 'close': '0.219', 'volume': '704', 'amount': '15392.96', 'interval': '1m'}, {'timestamp': '1609435440000', 'open': '0.2192', 'high': '0.2194', 'low': '0.2187', 'close': '0.2193', 'volume': '1537', 'amount': '33683.35', 'interval': '1m'}, {'timestamp': '1609435500000', 'open': '0.2194', 'high': '0.2195', 'low': '0.219', 'close': '0.2192', 'volume': '932', 'amount': '20436.43', 'interval': '1m'}, {'timestamp': '1609435560000', 'open': '0.2193', 'high': '0.2198', 'low': '0.2192', 'close': '0.2194', 'volume': '428', 'amount': '9391.39', 'interval': '1m'}, {'timestamp': '1609435620000', 'open': '0.2192', 'high': '0.2195', 'low': '0.2184', 'close': '0.2193', 'volume': '2409', 'amount': '52781.19', 'interval': '1m'}, {'timestamp': '1609435680000', 'open': '0.2194', 'high': '0.2195', 'low': '0.2192', 'close': '0.2192', 'volume': '648', 'amount': '14212.26', 'interval': '1m'}, {'timestamp': '1609435740000', 'open': '0.2191', 'high': '0.2193', 'low': '0.219', 'close': '0.219', 'volume': '267', 'amount': '5849.97', 'interval': '1m'}, {'timestamp': '1609435800000', 'open': '0.2188', 'high': '0.2191', 'low': '0.2187', 'close': '0.2191', 'volume': '1521', 'amount': '33298.49', 'interval': '1m'}, {'timestamp': '1609435860000', 'open': '0.2192', 'high': '0.2198', 'low': '0.2192', 'close': '0.2195', 'volume': '1551', 'amount': '34032.81', 'interval': '1m'}, {'timestamp': '1609435920000', 'open': '0.2195', 'high': '0.2205', 'low': '0.2195', 'close': '0.2199', 'volume': '3263', 'amount': '71737.05', 'interval': '1m'}, {'timestamp': '1609435980000', 'open': '0.2198', 'high': '0.2199', 'low': '0.2196', 'close': '0.2196', 'volume': '991', 'amount': '21774.74', 'interval': '1m'}, {'timestamp': '1609436040000', 'open': '0.2198', 'high': '0.2207', 'low': '0.2198', 'close': '0.2207', 'volume': '5384', 'amount': '118582.6', 'interval': '1m'}, {'timestamp': '1609436100000', 'open': '0.2206', 'high': '0.2206', 'low': '0.22', 'close': '0.2201', 'volume': '3473', 'amount': '76518.87', 'interval': '1m'}, {'timestamp': '1609436160000', 'open': '0.22', 'high': '0.22', 'low': '0.2189', 'close': '0.2189', 'volume': '2189', 'amount': '48037.6', 'interval': '1m'}, {'timestamp': '1609436220000', 'open': '0.219', 'high': '0.2192', 'low': '0.2184', 'close': '0.2189', 'volume': '890', 'amount': '19479.87', 'interval': '1m'}, {'timestamp': '1609436280000', 'open': '0.2189', 'high': '0.219', 'low': '0.2188', 'close': '0.2189', 'volume': '774', 'amount': '16942.86', 'interval': '1m'}, {'timestamp': '1609436340000', 'open': '0.2191', 'high': '0.2193', 'low': '0.2187', 'close': '0.2193', 'volume': '123', 'amount': '2694.93', 'interval': '1m'}, {'timestamp': '1609436400000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2187', 'close': '0.2188', 'volume': '304', 'amount': '6655.32', 'interval': '1m'}, {'timestamp': '1609436460000', 'open': '0.2188', 'high': '0.2189', 'low': '0.2183', 'close': '0.2183', 'volume': '2386', 'amount': '52151.99', 'interval': '1m'}, {'timestamp': '1609436520000', 'open': '0.2185', 'high': '0.219', 'low': '0.2185', 'close': '0.2186', 'volume': '624', 'amount': '13643.76', 'interval': '1m'}, {'timestamp': '1609436580000', 'open': '0.2186', 'high': '0.2187', 'low': '0.2186', 'close': '0.2187', 'volume': '111', 'amount': '2427.01', 'interval': '1m'}, {'timestamp': '1609436640000', 'open': '0.2186', 'high': '0.2196', 'low': '0.2186', 'close': '0.2187', 'volume': '2612', 'amount': '57170.15', 'interval': '1m'}, {'timestamp': '1609436700000', 'open': '0.2186', 'high': '0.2187', 'low': '0.2183', 'close': '0.2183', 'volume': '1217', 'amount': '26588.4', 'interval': '1m'}, {'timestamp': '1609436760000', 'open': '0.2183', 'high': '0.2187', 'low': '0.2183', 'close': '0.2187', 'volume': '897', 'amount': '19599.45', 'interval': '1m'}, {'timestamp': '1609436820000', 'open': '0.2186', 'high': '0.2187', 'low': '0.2186', 'close': '0.2186', 'volume': '116', 'amount': '2536.05', 'interval': '1m'}, {'timestamp': '1609436880000', 'open': '0.2187', 'high': '0.2193', 'low': '0.2186', 'close': '0.2191', 'volume': '574', 'amount': '12566.29', 'interval': '1m'}, {'timestamp': '1609436940000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2188', 'close': '0.2188', 'volume': '162', 'amount': '3546.99', 'interval': '1m'}, {'timestamp': '1609437000000', 'open': '0.2187', 'high': '0.2188', 'low': '0.2183', 'close': '0.2183', 'volume': '331', 'amount': '7233.17', 'interval': '1m'}, {'timestamp': '1609437060000', 'open': '0.2183', 'high': '0.2184', 'low': '0.2178', 'close': '0.2183', 'volume': '1442', 'amount': '31464.44', 'interval': '1m'}, {'timestamp': '1609437120000', 'open': '0.218', 'high': '0.2181', 'low': '0.2178', 'close': '0.2179', 'volume': '479', 'amount': '10439.8', 'interval': '1m'}, {'timestamp': '1609437180000', 'open': '0.2181', 'high': '0.2187', 'low': '0.218', 'close': '0.218', 'volume': '521', 'amount': '11368.22', 'interval': '1m'}, {'timestamp': '1609437240000', 'open': '0.218', 'high': '0.2183', 'low': '0.218', 'close': '0.2181', 'volume': '728', 'amount': '15877.68', 'interval': '1m'}, {'timestamp': '1609437300000', 'open': '0.2179', 'high': '0.2182', 'low': '0.2178', 'close': '0.218', 'volume': '736', 'amount': '16042.96', 'interval': '1m'}, {'timestamp': '1609437360000', 'open': '0.218', 'high': '0.218', 'low': '0.2177', 'close': '0.2177', 'volume': '89', 'amount': '1938.86', 'interval': '1m'}, {'timestamp': '1609437420000', 'open': '0.2177', 'high': '0.2178', 'low': '0.2173', 'close': '0.2178', 'volume': '5698', 'amount': '124016.97', 'interval': '1m'}, {'timestamp': '1609437480000', 'open': '0.2178', 'high': '0.2185', 'low': '0.2178', 'close': '0.2182', 'volume': '3222', 'amount': '70263.76', 'interval': '1m'}, {'timestamp': '1609437540000', 'open': '0.218', 'high': '0.2184', 'low': '0.2179', 'close': '0.2181', 'volume': '265', 'amount': '5779.65', 'interval': '1m'}, {'timestamp': '1609437600000', 'open': '0.2181', 'high': '0.2182', 'low': '0.2178', 'close': '0.2179', 'volume': '3517', 'amount': '76670.6', 'interval': '1m'}, {'timestamp': '1609437660000', 'open': '0.2179', 'high': '0.2181', 'low': '0.2179', 'close': '0.218', 'volume': '1864', 'amount': '40630.54', 'interval': '1m'}, {'timestamp': '1609437720000', 'open': '0.2182', 'high': '0.2192', 'low': '0.2182', 'close': '0.2187', 'volume': '3303', 'amount': '72195.32', 'interval': '1m'}, {'timestamp': '1609437780000', 'open': '0.2189', 'high': '0.2192', 'low': '0.2188', 'close': '0.2191', 'volume': '1046', 'amount': '22907.4', 'interval': '1m'}, {'timestamp': '1609437840000', 'open': '0.2191', 'high': '0.2191', 'low': '0.2185', 'close': '0.2186', 'volume': '939', 'amount': '20547.66', 'interval': '1m'}, {'timestamp': '1609437900000', 'open': '0.2186', 'high': '0.2186', 'low': '0.218', 'close': '0.2182', 'volume': '308', 'amount': '6725.18', 'interval': '1m'}, {'timestamp': '1609437960000', 'open': '0.2183', 'high': '0.2184', 'low': '0.218', 'close': '0.2182', 'volume': '1057', 'amount': '23066.38', 'interval': '1m'}, {'timestamp': '1609438020000', 'open': '0.2182', 'high': '0.2182', 'low': '0.2178', 'close': '0.218', 'volume': '271', 'amount': '5909.15', 'interval': '1m'}, {'timestamp': '1609438080000', 'open': '0.2181', 'high': '0.2181', 'low': '0.2179', 'close': '0.218', 'volume': '440', 'amount': '9593.1', 'interval': '1m'}, {'timestamp': '1609438140000', 'open': '0.218', 'high': '0.2182', 'low': '0.2179', 'close': '0.218', 'volume': '589', 'amount': '12841.67', 'interval': '1m'}, {'timestamp': '1609438200000', 'open': '0.2181', 'high': '0.2183', 'low': '0.2181', 'close': '0.2182', 'volume': '154', 'amount': '3359.89', 'interval': '1m'}, {'timestamp': '1609438260000', 'open': '0.2181', 'high': '0.2185', 'low': '0.218', 'close': '0.2185', 'volume': '409', 'amount': '8927.44', 'interval': '1m'}, {'timestamp': '1609438320000', 'open': '0.2183', 'high': '0.2184', 'low': '0.2181', 'close': '0.2184', 'volume': '181', 'amount': '3951.23', 'interval': '1m'}, {'timestamp': '1609438380000', 'open': '0.2184', 'high': '0.2184', 'low': '0.2181', 'close': '0.2184', 'volume': '118', 'amount': '2576.23', 'interval': '1m'}, {'timestamp': '1609438440000', 'open': '0.2184', 'high': '0.2184', 'low': '0.2181', 'close': '0.2181', 'volume': '54', 'amount': '1178.55', 'interval': '1m'}, {'timestamp': '1609438500000', 'open': '0.2181', 'high': '0.2184', 'low': '0.2177', 'close': '0.2182', 'volume': '2264', 'amount': '49377.84', 'interval': '1m'}, {'timestamp': '1609438560000', 'open': '0.2182', 'high': '0.2183', 'low': '0.218', 'close': '0.2183', 'volume': '98', 'amount': '2138.36', 'interval': '1m'}, {'timestamp': '1609438620000', 'open': '0.2186', 'high': '0.2191', 'low': '0.2184', 'close': '0.2189', 'volume': '2137', 'amount': '46746.87', 'interval': '1m'}, {'timestamp': '1609438680000', 'open': '0.2187', 'high': '0.2187', 'low': '0.2181', 'close': '0.2182', 'volume': '659', 'amount': '14394.2', 'interval': '1m'}, {'timestamp': '1609438740000', 'open': '0.2182', 'high': '0.2183', 'low': '0.2178', 'close': '0.2179', 'volume': '2037', 'amount': '44416.78', 'interval': '1m'}, {'timestamp': '1609438800000', 'open': '0.218', 'high': '0.2183', 'low': '0.2178', 'close': '0.2179', 'volume': '1538', 'amount': '33528.4', 'interval': '1m'}, {'timestamp': '1609438860000', 'open': '0.2181', 'high': '0.2183', 'low': '0.2179', 'close': '0.2183', 'volume': '113', 'amount': '2465.09', 'interval': '1m'}, {'timestamp': '1609438920000', 'open': '0.2181', 'high': '0.2184', 'low': '0.2179', 'close': '0.2182', 'volume': '542', 'amount': '11823.73', 'interval': '1m'}, {'timestamp': '1609438980000', 'open': '0.2182', 'high': '0.2185', 'low': '0.2182', 'close': '0.2183', 'volume': '124', 'amount': '2706.92', 'interval': '1m'}, {'timestamp': '1609439040000', 'open': '0.2182', 'high': '0.2183', 'low': '0.2179', 'close': '0.2179', 'volume': '59', 'amount': '1286.64', 'interval': '1m'}, {'timestamp': '1609439100000', 'open': '0.2178', 'high': '0.2181', 'low': '0.2178', 'close': '0.2179', 'volume': '179', 'amount': '3900.41', 'interval': '1m'}, {'timestamp': '1609439160000', 'open': '0.2179', 'high': '0.2183', 'low': '0.2179', 'close': '0.2183', 'volume': '134', 'amount': '2922.54', 'interval': '1m'}, {'timestamp': '1609439220000', 'open': '0.2184', 'high': '0.2185', 'low': '0.2181', 'close': '0.2181', 'volume': '420', 'amount': '9167.55', 'interval': '1m'}, {'timestamp': '1609439280000', 'open': '0.2181', 'high': '0.2186', 'low': '0.2181', 'close': '0.2183', 'volume': '693', 'amount': '15126.45', 'interval': '1m'}, {'timestamp': '1609439340000', 'open': '0.2182', 'high': '0.2184', 'low': '0.2182', 'close': '0.2182', 'volume': '93', 'amount': '2029.72', 'interval': '1m'}, {'timestamp': '1609439400000', 'open': '0.2182', 'high': '0.22', 'low': '0.2182', 'close': '0.2196', 'volume': '2941', 'amount': '64407.9', 'interval': '1m'}, {'timestamp': '1609439460000', 'open': '0.2198', 'high': '0.2198', 'low': '0.2191', 'close': '0.2192', 'volume': '609', 'amount': '13366.02', 'interval': '1m'}, {'timestamp': '1609439520000', 'open': '0.2192', 'high': '0.2192', 'low': '0.2187', 'close': '0.2189', 'volume': '2482', 'amount': '54355.8', 'interval': '1m'}, {'timestamp': '1609439580000', 'open': '0.2188', 'high': '0.2189', 'low': '0.2185', 'close': '0.2185', 'volume': '237', 'amount': '5182.59', 'interval': '1m'}, {'timestamp': '1609439640000', 'open': '0.2186', 'high': '0.2189', 'low': '0.2183', 'close': '0.2186', 'volume': '809', 'amount': '17684.74', 'interval': '1m'}, {'timestamp': '1609439700000', 'open': '0.2185', 'high': '0.2186', 'low': '0.2181', 'close': '0.2183', 'volume': '205', 'amount': '4476.68', 'interval': '1m'}, {'timestamp': '1609439760000', 'open': '0.2183', 'high': '0.2183', 'low': '0.2179', 'close': '0.2183', 'volume': '1733', 'amount': '37814.06', 'interval': '1m'}, {'timestamp': '1609439820000', 'open': '0.2182', 'high': '0.2184', 'low': '0.2182', 'close': '0.2183', 'volume': '120', 'amount': '2619.3', 'interval': '1m'}, {'timestamp': '1609439880000', 'open': '0.2187', 'high': '0.2187', 'low': '0.2182', 'close': '0.2182', 'volume': '177', 'amount': '3866.56', 'interval': '1m'}, {'timestamp': '1609439940000', 'open': '0.2181', 'high': '0.2184', 'low': '0.218', 'close': '0.2183', 'volume': '623', 'amount': '13593.86', 'interval': '1m'}, {'timestamp': '1609440000000', 'open': '0.2183', 'high': '0.2183', 'low': '0.2177', 'close': '0.2177', 'volume': '547', 'amount': '11924.6', 'interval': '1m'}, {'timestamp': '1609440060000', 'open': '0.218', 'high': '0.2182', 'low': '0.2177', 'close': '0.2177', 'volume': '254', 'amount': '5534.66', 'interval': '1m'}, {'timestamp': '1609440120000', 'open': '0.2177', 'high': '0.2177', 'low': '0.2162', 'close': '0.2174', 'volume': '2973', 'amount': '64588.42', 'interval': '1m'}, {'timestamp': '1609440180000', 'open': '0.2174', 'high': '0.2175', 'low': '0.2169', 'close': '0.2175', 'volume': '2053', 'amount': '44616.82', 'interval': '1m'}, {'timestamp': '1609440240000', 'open': '0.2176', 'high': '0.2177', 'low': '0.2173', 'close': '0.2176', 'volume': '219', 'amount': '4764.34', 'interval': '1m'}, {'timestamp': '1609440300000', 'open': '0.2176', 'high': '0.2186', 'low': '0.2176', 'close': '0.2177', 'volume': '960', 'amount': '20916', 'interval': '1m'}, {'timestamp': '1609440360000', 'open': '0.2181', 'high': '0.2182', 'low': '0.2179', 'close': '0.2179', 'volume': '197', 'amount': '4295.09', 'interval': '1m'}, {'timestamp': '1609440420000', 'open': '0.2178', 'high': '0.2178', 'low': '0.2171', 'close': '0.2171', 'volume': '308', 'amount': '6697.46', 'interval': '1m'}, {'timestamp': '1609440480000', 'open': '0.2168', 'high': '0.2173', 'low': '0.2166', 'close': '0.2173', 'volume': '2053', 'amount': '44550.1', 'interval': '1m'}, {'timestamp': '1609440540000', 'open': '0.2171', 'high': '0.2172', 'low': '0.2168', 'close': '0.2172', 'volume': '241', 'amount': '5231.5', 'interval': '1m'}, {'timestamp': '1609440600000', 'open': '0.2171', 'high': '0.2174', 'low': '0.2171', 'close': '0.2174', 'volume': '227', 'amount': '4931.57', 'interval': '1m'}, {'timestamp': '1609440660000', 'open': '0.2174', 'high': '0.2178', 'low': '0.2174', 'close': '0.2174', 'volume': '691', 'amount': '15029.25', 'interval': '1m'}, {'timestamp': '1609440720000', 'open': '0.2174', 'high': '0.2177', 'low': '0.2173', 'close': '0.2175', 'volume': '1029', 'amount': '22378.17', 'interval': '1m'}, {'timestamp': '1609440780000', 'open': '0.2174', 'high': '0.2177', 'low': '0.2173', 'close': '0.2175', 'volume': '709', 'amount': '15418.97', 'interval': '1m'}, {'timestamp': '1609440840000', 'open': '0.2176', 'high': '0.2183', 'low': '0.2176', 'close': '0.2182', 'volume': '595', 'amount': '12966.53', 'interval': '1m'}, {'timestamp': '1609440900000', 'open': '0.2182', 'high': '0.2182', 'low': '0.2179', 'close': '0.2179', 'volume': '521', 'amount': '11360.4', 'interval': '1m'}, {'timestamp': '1609440960000', 'open': '0.2178', 'high': '0.2182', 'low': '0.2178', 'close': '0.2182', 'volume': '297', 'amount': '6474.6', 'interval': '1m'}, {'timestamp': '1609441020000', 'open': '0.2182', 'high': '0.2183', 'low': '0.2179', 'close': '0.2181', 'volume': '483', 'amount': '10535.43', 'interval': '1m'}, {'timestamp': '1609441080000', 'open': '0.2181', 'high': '0.2183', 'low': '0.2181', 'close': '0.2181', 'volume': '132', 'amount': '2879.58', 'interval': '1m'}, {'timestamp': '1609441140000', 'open': '0.2181', 'high': '0.2183', 'low': '0.2181', 'close': '0.2182', 'volume': '156', 'amount': '3403.53', 'interval': '1m'}, {'timestamp': '1609441200000', 'open': '0.2183', 'high': '0.2184', 'low': '0.218', 'close': '0.218', 'volume': '209', 'amount': '4559.85', 'interval': '1m'}, {'timestamp': '1609441260000', 'open': '0.218', 'high': '0.2185', 'low': '0.218', 'close': '0.2184', 'volume': '588', 'amount': '12831.63', 'interval': '1m'}, {'timestamp': '1609441320000', 'open': '0.2182', 'high': '0.2188', 'low': '0.2182', 'close': '0.2188', 'volume': '187', 'amount': '4085.95', 'interval': '1m'}, {'timestamp': '1609441380000', 'open': '0.2187', 'high': '0.2195', 'low': '0.2187', 'close': '0.2193', 'volume': '3996', 'amount': '87532.38', 'interval': '1m'}, {'timestamp': '1609441440000', 'open': '0.2192', 'high': '0.2196', 'low': '0.2189', 'close': '0.219', 'volume': '869', 'amount': '19046.3', 'interval': '1m'}, {'timestamp': '1609441500000', 'open': '0.2189', 'high': '0.2227', 'low': '0.2188', 'close': '0.2224', 'volume': '27256', 'amount': '601539.92', 'interval': '1m'}, {'timestamp': '1609441560000', 'open': '0.2224', 'high': '0.2233', 'low': '0.2213', 'close': '0.2216', 'volume': '10151', 'amount': '225504.46', 'interval': '1m'}, {'timestamp': '1609441620000', 'open': '0.2215', 'high': '0.222', 'low': '0.2212', 'close': '0.2219', 'volume': '3238', 'amount': '71770.27', 'interval': '1m'}, {'timestamp': '1609441680000', 'open': '0.2218', 'high': '0.2218', 'low': '0.2211', 'close': '0.2211', 'volume': '2986', 'amount': '66124.97', 'interval': '1m'}, {'timestamp': '1609441740000', 'open': '0.221', 'high': '0.2217', 'low': '0.221', 'close': '0.2213', 'volume': '2275', 'amount': '50334.37', 'interval': '1m'}, {'timestamp': '1609441800000', 'open': '0.2212', 'high': '0.2212', 'low': '0.2202', 'close': '0.2209', 'volume': '9756', 'amount': '215485.65', 'interval': '1m'}, {'timestamp': '1609441860000', 'open': '0.2207', 'high': '0.2208', 'low': '0.2201', 'close': '0.2207', 'volume': '1512', 'amount': '33350.94', 'interval': '1m'}, {'timestamp': '1609441920000', 'open': '0.2204', 'high': '0.2206', 'low': '0.2201', 'close': '0.2205', 'volume': '4018', 'amount': '88556.72', 'interval': '1m'}, {'timestamp': '1609441980000', 'open': '0.2205', 'high': '0.2208', 'low': '0.2202', 'close': '0.2204', 'volume': '1159', 'amount': '25553.05', 'interval': '1m'}, {'timestamp': '1609442040000', 'open': '0.2204', 'high': '0.2206', 'low': '0.2202', 'close': '0.2203', 'volume': '818', 'amount': '18026.67', 'interval': '1m'}, {'timestamp': '1609442100000', 'open': '0.2203', 'high': '0.2204', 'low': '0.2201', 'close': '0.2202', 'volume': '1929', 'amount': '42486.22', 'interval': '1m'}, {'timestamp': '1609442160000', 'open': '0.2203', 'high': '0.2205', 'low': '0.2203', 'close': '0.2203', 'volume': '374', 'amount': '8241.09', 'interval': '1m'}, {'timestamp': '1609442220000', 'open': '0.2203', 'high': '0.2206', 'low': '0.2203', 'close': '0.2205', 'volume': '318', 'amount': '7009.51', 'interval': '1m'}, {'timestamp': '1609442280000', 'open': '0.2205', 'high': '0.221', 'low': '0.2205', 'close': '0.2207', 'volume': '321', 'amount': '7083.66', 'interval': '1m'}, {'timestamp': '1609442340000', 'open': '0.2205', 'high': '0.2205', 'low': '0.2197', 'close': '0.2197', 'volume': '2612', 'amount': '57490.12', 'interval': '1m'}
]
def data():
    for row in rows:
        k = G(timestamp=int(row["timestamp"]), open=float(row["open"]), high=float(row["high"]), low=float(row["low"]),
              close=float(row["close"]), volume=float(row["volume"]), amount=float(row["amount"]))
        yield k


def test_ops():
    exps = {
        "ADD": "$close + 1",
        "RADD": "1 + $close",
        "SUB": "$close - 1",
        "RSUB": "1 - $close",
        "MUL": "$close * 2",
        "RMUL": "2 * $close",
        "DIV": "$close / 2",
        "RDIV": "2 / $close",
        "TRUEDIV": "$close / 2",
        "RTRUEDIV": "(2 + 1e-12) / $amount",
    }
    ps = [Processor(k, exps[k]) for k in exps]
    for k in data():
        for p in ps:
            p.next(k)
        assert k.close + 1 == k.ADD
        assert 1 + k.close == k.RADD
        assert k.close - 1 == k.SUB
        assert 1 - k.close == k.RSUB

        assert k.close * 2 == k.MUL
        assert 2 * k.close == k.RMUL
        assert k.close / 2 == k.DIV
        assert 2 / k.close == k.RDIV
        assert k.close / 2 == k.TRUEDIV
        assert (2 + 1e-12) / k.amount == k.RTRUEDIV


def test_ref():
    exps = {
        "CHANGE1": "$close - ref($close, 1)",
        "CHANGE2": "$close - ref($close, 2)",
        "RATE_OF_CHANGE1": "($close - ref($close, 1)) / ($close + 1e-12)",
        "RATE_OF_CHANGE2": "($close - ref($close, 2)) / ($close + 1e-12)",
    }
    q = deque(maxlen=2)
    ps = [Processor(k, exps[k]) for k in exps]
    for k in data():
        for p in ps:
            p.next(k)
        if len(q) >= 1:
            assert (k.close - q[-1].close) == k.CHANGE1
            assert (k.close - q[-1].close) / (k.close + 1e-12) == k.RATE_OF_CHANGE1, f"{(k.close - q[-1].close) / (k.close + 1e-12)} , {k.RATE_OF_CHANGE1}"
        else:
            assert k.CHANGE1 is None
            assert k.RATE_OF_CHANGE1 is None
        if len(q) >= 2:
            assert (k.close - q[-2].close) == k.CHANGE2, f"{k.CHANGE2} != {(k.close - q[-2].close)}"
            assert (k.close - q[-2].close) / (k.close + 1e-12) == k.RATE_OF_CHANGE2
        else:
            assert k.CHANGE2 is None
            assert k.RATE_OF_CHANGE2 is None
        q.append(k)

def test_max():
    exps = {
        "MAX1": "larger($close, ref($close, 1))",
        "MAX2": "larger($close, $open, 1)",
        "MIN1": "smaller($close, ref($close, 1))",
        "MIN2": "smaller($close, $open, 1)",
        "ABS1": "abs($close - ref($close, 1))",
        "ABS2": "abs($close - 1)",
    }
    q = deque(maxlen=2)
    ps = Processor.wrapper_processor(exps)
    for k in data():
        ps(k)
        assert max(k.close, k.open, 1) == k.MAX2
        assert min(k.close, k.open, 1) == k.MIN2
        assert abs(k.close - 1) == k.ABS2
        if len(q) >= 1:
            assert max(k.close, q[-1].close) == k.MAX1
            assert min(k.close, q[-1].close) == k.MIN1
            assert abs(k.close - q[-1].close) == k.ABS1
        else:
            assert k.close == k.MAX1
            assert k.close == k.MIN1
            assert k.ABS1 is None
        q.append(k)


def test_ta1():
    exps = {
        "sma5": "sma($close, 5)",
        "sma20": "sma($close, 20)",
        "std1": "std($close, 20)",
        "std2": "std($close, 60)",
        "max1": "max($close, 20)",
        "max2": "max($close, 60)",
        "min1": "min($close, 20)",
        "min2": "min($close, 60)",
    }
    ma5 = MA(window=5)
    ma20 = MA(window=20)
    q = deque(maxlen=61)
    ps = Processor.wrapper_processor(exps)
    for k in data():
        k.finish = 1
        ps(k)
        m5 = ma5.update(k)
        m20 = ma20.update(k)
        assert m5 == k.sma5 or abs(m5 - k.sma5) < 1e-12, f"{m5} != {k.sma5}"
        assert m20 == k.sma20 or abs(m20 - k.sma20) < 1e-12, f"{m20} != {k.sma20}"
        q.append(k)

        std20 = None
        if len(q) >= 20:
            std20 = np.std([x.close for x in list(q)[-20:]])
        assert k.std1 == std20 or abs(k.std1 - std20) < 1e-12, f"{k.std1} != {std20}"
        assert max([x.close for x in list(q)[-20:]]) == k.max1
        assert max([x.close for x in list(q)[-60:]]) == k.max2
        assert min([x.close for x in list(q)[-20:]]) == k.min1
        assert min([x.close for x in list(q)[-60:]]) == k.min2

        std60 = None
        if len(q) >= 60:
            std60 = np.std([x.close for x in list(q)[-60:]])
        assert k.std2 == std60 or abs(k.std2 - std60) < 1e-12, f"{k.std2} != {std60}"


def test_count():
    exps = {
        "count1": "count($close > $open, 60)",
        "count2": "count($close > 0.21, 60)",
        "count3": "count(1 >= $close >= 0.21, 60)",
        "count4": "count(1 > $close > 0.21, 60)",
        "count5": "count($close>ref($close, 1), 60)",
        "sum1": "sum(larger($close-ref($close, 1), 0), 60)",
        "log1": "log($volume+1)",
    }
    q = deque(maxlen=60)
    pre = None
    q1 = deque(maxlen=60)
    q2 = deque(maxlen=60)
    ps = Processor.wrapper_processor(exps)
    for k in data():
        k.finish = 1
        ps(k)
        q.append(k)
        if pre is None:
            pre = k.close
        else:
            q1.append(k.close > pre)
            q2.append(k.close - pre)
            pre = k.close
        assert k.log1 == np.log(k.volume + 1)
        if len(q) < 60:
            assert k.count1 is None
            assert k.count2 is None
            assert k.count3 is None
            assert k.count4 is None
        else:
            assert k.count1 == sum(1 for x in list(q) if x.close > x.open)
            assert k.count2 == sum(1 for x in list(q) if x.close > 0.21)
            assert k.count3 == sum(1 for x in list(q) if 1 >= x.close >= 0.21)
            assert k.count4 == sum(1 for x in list(q) if 1 > x.close > 0.21)
            assert k.count5 == sum(1 for x in list(q1) if x), f"{k.count5} != {sum(1 for x in list(q1) if x)}"
            assert k.sum1 == sum(x for x in list(q2) if x > 0)

if __name__ == '__main__':
    test_ops()
    test_ref()
    test_max()
    test_ta1()
    test_count()
